{% extends "base.html" %}

{% block title %}Map - EPC Data Explorer{% endblock %}

{% block content %}
<div class="row">
    <!-- Page Header -->
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="display-5 fw-bold text-primary">
                    <i class="fas fa-map me-3"></i>Interactive EPC Map
                </h1>
                <p class="lead text-muted">Visualize Energy Performance Certificate data on an interactive map</p>
            </div>
            <div class="btn-group">
                <button class="btn btn-success" id="loadFromSearch" style="display: none;">
                    <i class="fas fa-search me-1"></i>Load Search Results
                </button>
                <button class="btn btn-primary" id="searchOnMap">
                    <i class="fas fa-plus me-1"></i>New Search
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Map Controls -->
<div class="row mb-3" id="mapControls" style="display: none;">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h6 class="mb-0"><i class="fas fa-layer-group me-2"></i>Map Controls</h6>
            </div>
            <div class="card-body py-2">
                <div class="row align-items-center">
                    <div class="col-md-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="showHeatmap">
                            <label class="form-check-label" for="showHeatmap">
                                Heat Map
                            </label>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select form-select-sm" id="colorBy">
                            <option value="energy-rating">Energy Rating</option>
                            <option value="efficiency">Efficiency Score</option>
                            <option value="property-type">Property Type</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <div class="d-flex align-items-center">
                            <label class="form-label mb-0 me-2" style="font-size: 0.875rem;">Opacity:</label>
                            <input type="range" class="form-range" id="opacitySlider" min="0.1" max="1" step="0.1" value="0.7">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-end">
                            <span class="badge bg-primary" id="pointCount">0 points</span>
                            <button class="btn btn-outline-secondary btn-sm ms-2" id="clearMap">
                                <i class="fas fa-trash"></i> Clear
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Map Container -->
<div class="row">
    <div class="col-md-9">
        <div class="card">
            <div class="card-body p-0">
                <div id="mapContainer" class="map-container">
                    <div class="d-flex align-items-center justify-content-center h-100 text-muted">
                        <div class="text-center">
                            <i class="fas fa-map fa-3x mb-3"></i>
                            <h5>No Data Loaded</h5>
                            <p>Perform a search or load existing data to view on the map</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Map Sidebar -->
    <div class="col-md-3">
        <div class="sidebar">
            <!-- Quick Search -->
            <div class="card mb-3">
                <div class="card-header bg-primary text-white">
                    <h6 class="mb-0"><i class="fas fa-search me-2"></i>Quick Search</h6>
                </div>
                <div class="card-body">
                    <form id="quickSearchForm">
                        <div class="mb-2">
                            <input type="text" class="form-control form-control-sm" id="quickSearchQuery" 
                                   placeholder="Postcode or area...">
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary btn-sm">
                                <i class="fas fa-search me-1"></i>Search & Map
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Map Legend -->
            <div class="card mb-3">
                <div class="card-header bg-secondary text-white">
                    <h6 class="mb-0"><i class="fas fa-palette me-2"></i>Legend</h6>
                </div>
                <div class="card-body">
                    <div id="mapLegend">
                        <div class="mb-2">
                            <div class="d-flex align-items-center">
                                <div class="rounded-circle me-2" style="width: 12px; height: 12px; background-color: #2d5aa0;"></div>
                                <small>A - Very Efficient</small>
                            </div>
                        </div>
                        <div class="mb-2">
                            <div class="d-flex align-items-center">
                                <div class="rounded-circle me-2" style="width: 12px; height: 12px; background-color: #2f7ed8;"></div>
                                <small>B - Efficient</small>
                            </div>
                        </div>
                        <div class="mb-2">
                            <div class="d-flex align-items-center">
                                <div class="rounded-circle me-2" style="width: 12px; height: 12px; background-color: #0d8ecf;"></div>
                                <small>C - Good</small>
                            </div>
                        </div>
                        <div class="mb-2">
                            <div class="d-flex align-items-center">
                                <div class="rounded-circle me-2" style="width: 12px; height: 12px; background-color: #2b908f;"></div>
                                <small>D - Average</small>
                            </div>
                        </div>
                        <div class="mb-2">
                            <div class="d-flex align-items-center">
                                <div class="rounded-circle me-2" style="width: 12px; height: 12px; background-color: #90ed7d;"></div>
                                <small>E - Below Average</small>
                            </div>
                        </div>
                        <div class="mb-2">
                            <div class="d-flex align-items-center">
                                <div class="rounded-circle me-2" style="width: 12px; height: 12px; background-color: #f7a35c;"></div>
                                <small>F - Poor</small>
                            </div>
                        </div>
                        <div class="mb-2">
                            <div class="d-flex align-items-center">
                                <div class="rounded-circle me-2" style="width: 12px; height: 12px; background-color: #8085e9;"></div>
                                <small>G - Very Poor</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Map Statistics -->
            <div class="card mb-3">
                <div class="card-header bg-success text-white">
                    <h6 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Map Statistics</h6>
                </div>
                <div class="card-body">
                    <div id="mapStats">
                        <div class="text-center text-muted">
                            <small>Load data to see statistics</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Export Options -->
            <div class="card">
                <div class="card-header bg-warning text-white">
                    <h6 class="mb-0"><i class="fas fa-download me-2"></i>Export Map Data</h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary btn-sm" id="exportMapData" disabled>
                            <i class="fas fa-file-csv me-1"></i>Export CSV
                        </button>
                        <button class="btn btn-outline-success btn-sm" id="exportMapGeoJSON" disabled>
                            <i class="fas fa-map me-1"></i>Export GeoJSON
                        </button>
                        <button class="btn btn-outline-info btn-sm" id="saveMapImage" disabled>
                            <i class="fas fa-camera me-1"></i>Save Map Image
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
let currentMapData = [];
let mapInstance = null;

document.addEventListener('DOMContentLoaded', function() {
    // Check if we have data from search results
    const searchData = sessionStorage.getItem('mapData');
    if (searchData) {
        document.getElementById('loadFromSearch').style.display = 'inline-block';
        document.getElementById('loadFromSearch').addEventListener('click', function() {
            const data = JSON.parse(searchData);
            loadMapData(data);
            sessionStorage.removeItem('mapData'); // Clear after use
            this.style.display = 'none';
        });
    }
    
    initializeEventListeners();
});

function initializeEventListeners() {
    // Quick search form
    document.getElementById('quickSearchForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const query = document.getElementById('quickSearchQuery').value.trim();
        if (query) {
            performQuickSearch(query);
        }
    });
    
    // Map controls
    document.getElementById('colorBy').addEventListener('change', updateMapVisualization);
    document.getElementById('opacitySlider').addEventListener('input', updateMapVisualization);
    document.getElementById('showHeatmap').addEventListener('change', updateMapVisualization);
    
    // Clear map
    document.getElementById('clearMap').addEventListener('click', clearMap);
    
    // Export buttons
    document.getElementById('exportMapData').addEventListener('click', () => exportMapData('csv'));
    document.getElementById('exportMapGeoJSON').addEventListener('click', () => exportMapData('geojson'));
    
    // Search on map button
    document.getElementById('searchOnMap').addEventListener('click', function() {
        window.location.href = '{{ url_for("search_page") }}';
    });
}

function performQuickSearch(query) {
    const searchBtn = document.querySelector('#quickSearchForm button');
    const originalHTML = searchBtn.innerHTML;
    searchBtn.innerHTML = '<span class="loading-spinner"></span>Searching...';
    searchBtn.disabled = true;
    
    // Determine search type based on query format
    let searchType = 'postcode';
    if (!/^[A-Z]{1,2}[0-9]{1,2}[A-Z]?\s?[0-9][A-Z]{2}$|^[A-Z]{1,2}[0-9]{1,2}[A-Z]?$|^[A-Z]{1,2}[0-9]$/.test(query.toUpperCase())) {
        searchType = 'local_authority';
    }
    
    const requestData = {
        search_type: searchType,
        query: query,
        property_type: 'domestic',
        agricultural: false
    };
    
    fetch('/api/search', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(requestData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.data.length > 0) {
            loadMapData(data.data);
        } else {
            alert('No results found for: ' + query);
        }
    })
    .catch(error => {
        console.error('Search error:', error);
        alert('Search failed: ' + error.message);
    })
    .finally(() => {
        searchBtn.innerHTML = originalHTML;
        searchBtn.disabled = false;
    });
}

function loadMapData(data) {
    if (!data || data.length === 0) {
        return;
    }
    
    currentMapData = data;
    
    // Show map controls
    document.getElementById('mapControls').style.display = 'block';
    
    // Generate map
    generateMap(data);
    
    // Update statistics
    updateMapStatistics(data);
    
    // Enable export buttons
    document.getElementById('exportMapData').disabled = false;
    document.getElementById('exportMapGeoJSON').disabled = false;
    document.getElementById('saveMapImage').disabled = false;
}

function generateMap(data) {
    const mapContainer = document.getElementById('mapContainer');
    mapContainer.innerHTML = '<div class="d-flex align-items-center justify-content-center h-100"><div class="loading-spinner" style="width: 40px; height: 40px; border-width: 4px;"></div><h6 class="ms-3">Generating map...</h6></div>';
    
    fetch('/api/map_data', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ data: data })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            mapContainer.innerHTML = result.map_html;
            document.getElementById('pointCount').textContent = `${result.point_count} points`;
        } else {
            mapContainer.innerHTML = `
                <div class="d-flex align-items-center justify-content-center h-100 text-danger">
                    <div class="text-center">
                        <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                        <h5>Map Generation Failed</h5>
                        <p>${result.error || 'Unknown error occurred'}</p>
                    </div>
                </div>
            `;
        }
    })
    .catch(error => {
        console.error('Map generation error:', error);
        mapContainer.innerHTML = `
            <div class="d-flex align-items-center justify-content-center h-100 text-danger">
                <div class="text-center">
                    <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                    <h5>Map Error</h5>
                    <p>${error.message}</p>
                </div>
            </div>
        `;
    });
}

function updateMapVisualization() {
    // This would update map styling based on controls
    // For now, we'll regenerate the map with current data
    if (currentMapData.length > 0) {
        generateMap(currentMapData);
    }
}

function updateMapStatistics(data) {
    const statsContainer = document.getElementById('mapStats');
    
    // Calculate statistics
    const totalProperties = data.length;
    const ratings = {};
    const propertyTypes = {};
    let avgEfficiency = 0;
    let efficiencyCount = 0;
    
    data.forEach(property => {
        const rating = property['current-energy-rating'];
        const propType = property['property-type'];
        const efficiency = parseFloat(property['current-energy-efficiency']);
        
        if (rating) {
            ratings[rating] = (ratings[rating] || 0) + 1;
        }
        if (propType) {
            propertyTypes[propType] = (propertyTypes[propType] || 0) + 1;
        }
        if (!isNaN(efficiency)) {
            avgEfficiency += efficiency;
            efficiencyCount++;
        }
    });
    
    avgEfficiency = efficiencyCount > 0 ? (avgEfficiency / efficiencyCount).toFixed(1) : 'N/A';
    
    // Most common rating
    const mostCommonRating = Object.keys(ratings).reduce((a, b) => ratings[a] > ratings[b] ? a : b, 'N/A');
    
    statsContainer.innerHTML = `
        <div class="mb-2">
            <small class="text-muted">Total Properties:</small>
            <div class="fw-bold">${totalProperties.toLocaleString()}</div>
        </div>
        <div class="mb-2">
            <small class="text-muted">Most Common Rating:</small>
            <div><span class="energy-rating ${mostCommonRating}">${mostCommonRating}</span></div>
        </div>
        <div class="mb-2">
            <small class="text-muted">Avg Efficiency:</small>
            <div class="fw-bold">${avgEfficiency}</div>
        </div>
        <div class="mb-2">
            <small class="text-muted">Property Types:</small>
            <div class="small">
                ${Object.entries(propertyTypes)
                    .slice(0, 3)
                    .map(([type, count]) => `${type}: ${count}`)
                    .join('<br>')}
            </div>
        </div>
    `;
}

function clearMap() {
    currentMapData = [];
    document.getElementById('mapContainer').innerHTML = `
        <div class="d-flex align-items-center justify-content-center h-100 text-muted">
            <div class="text-center">
                <i class="fas fa-map fa-3x mb-3"></i>
                <h5>No Data Loaded</h5>
                <p>Perform a search or load existing data to view on the map</p>
            </div>
        </div>
    `;
    
    document.getElementById('mapControls').style.display = 'none';
    document.getElementById('pointCount').textContent = '0 points';
    document.getElementById('mapStats').innerHTML = '<div class="text-center text-muted"><small>Load data to see statistics</small></div>';
    
    // Disable export buttons
    document.getElementById('exportMapData').disabled = true;
    document.getElementById('exportMapGeoJSON').disabled = true;
    document.getElementById('saveMapImage').disabled = true;
}

function exportMapData(format) {
    if (currentMapData.length === 0) {
        alert('No data to export');
        return;
    }
    
    const exportData = {
        format: format,
        filename: `map_data_${new Date().toISOString().slice(0,10)}`,
        search_data: currentMapData
    };
    
    fetch('/api/export', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(exportData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.href = data.download_url;
        } else {
            alert('Export failed: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Export error:', error);
        alert('Export failed: ' + error.message);
    });
}
</script>
{% endblock %}