{% extends "base.html" %}

{% block title %}Search - EPC Data Explorer{% endblock %}

{% block content %}
<div class="row">
    <!-- Page Header -->
    <div class="col-12">
        <div class="mb-4">
            <h1 class="display-5 fw-bold text-primary">
                <i class="fas fa-search me-3"></i>Search EPC Data
            </h1>
            <p class="lead text-muted">Search UK Energy Performance Certificate data by postcode, local authority, or UPRN</p>
        </div>
    </div>
</div>

<!-- Search Form -->
<div class="row">
    <div class="col-12">
        <div class="search-container">
            <form id="searchForm">
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <label for="searchType" class="form-label fw-bold">Search Type</label>
                        <select class="form-select" id="searchType" required>
                            <option value="postcode">Postcode</option>
                            <option value="local_authority">Local Authority</option>
                            <option value="uprn">UPRN</option>
                        </select>
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <label for="searchQuery" class="form-label fw-bold">Search Query</label>
                        <input type="text" class="form-control" id="searchQuery" 
                               placeholder="Enter postcode, local authority, or UPRN..." required>
                        <div class="form-text" id="searchHint">
                            Enter a UK postcode (e.g., GU1 1AA, M1)
                        </div>
                    </div>
                    
                    <div class="col-md-2 mb-3">
                        <label for="propertyType" class="form-label fw-bold">Property Type</label>
                        <select class="form-select" id="propertyType">
                            <option value="domestic">Domestic</option>
                            <option value="non-domestic">Non-Domestic</option>
                        </select>
                    </div>
                    
                    <div class="col-md-2 mb-3">
                        <label class="form-label fw-bold">Options</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="agricultural">
                            <label class="form-check-label" for="agricultural">
                                Agricultural Only
                            </label>
                        </div>
                    </div>
                    
                    <div class="col-md-1 mb-3">
                        <label class="form-label fw-bold">&nbsp;</label>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Search Results -->
<div class="row" id="resultsSection" style="display: none;">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-table me-2"></i>Search Results
                    <span class="badge bg-light text-dark ms-2" id="resultCount">0</span>
                </h5>
                <div class="btn-group">
                    <button class="btn btn-light btn-sm" id="exportCsv">
                        <i class="fas fa-file-csv me-1"></i>Export CSV
                    </button>
                    <button class="btn btn-light btn-sm" id="exportGeoJson">
                        <i class="fas fa-map me-1"></i>Export GeoJSON
                    </button>
                    <button class="btn btn-light btn-sm" id="viewMap">
                        <i class="fas fa-map-marked-alt me-1"></i>View on Map
                    </button>
                    <button class="btn btn-light btn-sm" id="showAnalytics">
                        <i class="fas fa-chart-bar me-1"></i>Analytics
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0" id="resultsTable">
                        <thead>
                            <tr>
                                <th>Address</th>
                                <th>Postcode</th>
                                <th>Energy Rating</th>
                                <th>Efficiency Score</th>
                                <th>Property Type</th>
                                <th>Floor Area (mÂ²)</th>
                                <th>Inspection Date</th>
                                <th>Local Authority</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Indicator -->
<div class="row" id="loadingSection" style="display: none;">
    <div class="col-12">
        <div class="text-center py-5">
            <div class="loading-spinner" style="width: 40px; height: 40px; border-width: 4px;"></div>
            <h5 class="mt-3">Searching EPC Database...</h5>
            <p class="text-muted">This may take a few moments for large result sets</p>
        </div>
    </div>
</div>

<!-- Export Modal -->
<div class="modal fade" id="exportModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Export Data</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="exportForm">
                    <div class="mb-3">
                        <label for="exportFormat" class="form-label">Export Format</label>
                        <select class="form-select" id="exportFormat">
                            <option value="csv">CSV (Spreadsheet)</option>
                            <option value="geojson">GeoJSON (LandApp Compatible)</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="exportFilename" class="form-label">Filename</label>
                        <input type="text" class="form-control" id="exportFilename" 
                               placeholder="epc_export" required>
                        <div class="form-text">Extension will be added automatically</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmExport">
                    <i class="fas fa-download me-1"></i>Export
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
let currentResults = [];
let searchInProgress = false;

document.addEventListener('DOMContentLoaded', function() {
    // Initialize search hints
    updateSearchHint();
    
    // Pre-fill from URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('type') && urlParams.has('q')) {
        document.getElementById('searchType').value = urlParams.get('type');
        document.getElementById('searchQuery').value = urlParams.get('q');
        updateSearchHint();
        // Auto-search if parameters are provided
        setTimeout(() => document.getElementById('searchForm').dispatchEvent(new Event('submit')), 500);
    }
});

document.getElementById('searchType').addEventListener('change', updateSearchHint);

function updateSearchHint() {
    const searchType = document.getElementById('searchType').value;
    const hintElement = document.getElementById('searchHint');
    const queryInput = document.getElementById('searchQuery');
    
    switch(searchType) {
        case 'postcode':
            hintElement.textContent = 'Enter a UK postcode (e.g., GU1 1AA, M1, SW1A)';
            queryInput.placeholder = 'Enter postcode...';
            break;
        case 'local_authority':
            hintElement.textContent = 'Enter local authority name (e.g., Surrey, Guildford, Manchester)';
            queryInput.placeholder = 'Enter local authority...';
            break;
        case 'uprn':
            hintElement.textContent = 'Enter Unique Property Reference Number (e.g., 100062297308)';
            queryInput.placeholder = 'Enter UPRN...';
            break;
    }
}

document.getElementById('searchForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    if (searchInProgress) {
        return;
    }
    
    const searchType = document.getElementById('searchType').value;
    const query = document.getElementById('searchQuery').value.trim();
    const propertyType = document.getElementById('propertyType').value;
    const agricultural = document.getElementById('agricultural').checked;
    
    if (!query) {
        alert('Please enter a search query');
        return;
    }
    
    performSearch(searchType, query, propertyType, agricultural);
});

function performSearch(searchType, query, propertyType, agricultural) {
    searchInProgress = true;
    
    // Show loading, hide results
    document.getElementById('loadingSection').style.display = 'block';
    document.getElementById('resultsSection').style.display = 'none';
    
    // Disable form
    document.getElementById('searchForm').querySelectorAll('input, select, button').forEach(el => {
        el.disabled = true;
    });
    
    const requestData = {
        search_type: searchType,
        query: query,
        property_type: propertyType,
        agricultural: agricultural
    };
    
    fetch('/api/search', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(requestData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayResults(data.data, data.total_found);
            currentResults = data.data;
        } else {
            alert('Search failed: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Search error:', error);
        alert('Search failed: ' + error.message);
    })
    .finally(() => {
        searchInProgress = false;
        
        // Hide loading
        document.getElementById('loadingSection').style.display = 'none';
        
        // Re-enable form
        document.getElementById('searchForm').querySelectorAll('input, select, button').forEach(el => {
            el.disabled = false;
        });
    });
}

function displayResults(results, totalFound) {
    const tableBody = document.querySelector('#resultsTable tbody');
    const resultCount = document.getElementById('resultCount');
    
    tableBody.innerHTML = '';
    resultCount.textContent = `${results.length} of ${totalFound}`;
    
    if (results.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="8" class="text-center text-muted py-4">No results found</td></tr>';
    } else {
        results.forEach(row => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${row['address1'] || 'N/A'}</td>
                <td><code>${row['postcode'] || 'N/A'}</code></td>
                <td><span class="energy-rating ${row['current-energy-rating'] || 'N/A'}">${row['current-energy-rating'] || 'N/A'}</span></td>
                <td>${row['current-energy-efficiency'] || 'N/A'}</td>
                <td>${row['property-type'] || 'N/A'}</td>
                <td>${row['total-floor-area'] || 'N/A'}</td>
                <td>${row['inspection-date'] ? new Date(row['inspection-date']).toLocaleDateString() : 'N/A'}</td>
                <td>${row['local-authority'] || 'N/A'}</td>
            `;
            tableBody.appendChild(tr);
        });
        
        // Initialize DataTable if not already initialized
        if (!$.fn.DataTable.isDataTable('#resultsTable')) {
            $('#resultsTable').DataTable({
                pageLength: 25,
                responsive: true,
                order: [[6, 'desc']] // Sort by inspection date
            });
        }
    }
    
    document.getElementById('resultsSection').style.display = 'block';
}

// Export functionality
document.getElementById('exportCsv').addEventListener('click', function() {
    showExportModal('csv');
});

document.getElementById('exportGeoJson').addEventListener('click', function() {
    showExportModal('geojson');
});

function showExportModal(format) {
    if (currentResults.length === 0) {
        alert('No data to export. Please perform a search first.');
        return;
    }
    
    document.getElementById('exportFormat').value = format;
    document.getElementById('exportFilename').value = `epc_export_${new Date().toISOString().slice(0,10)}`;
    
    const modal = new bootstrap.Modal(document.getElementById('exportModal'));
    modal.show();
}

document.getElementById('confirmExport').addEventListener('click', function() {
    const format = document.getElementById('exportFormat').value;
    const filename = document.getElementById('exportFilename').value;
    
    if (!filename.trim()) {
        alert('Please enter a filename');
        return;
    }
    
    const exportData = {
        format: format,
        filename: filename,
        search_data: currentResults
    };
    
    // Show loading state
    this.innerHTML = '<span class="loading-spinner"></span>Exporting...';
    this.disabled = true;
    
    fetch('/api/export', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(exportData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Trigger download
            window.location.href = data.download_url;
            
            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('exportModal')).hide();
            
            // Show success message
            showAlert('success', `Export successful! File: ${data.filepath}`);
        } else {
            alert('Export failed: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Export error:', error);
        alert('Export failed: ' + error.message);
    })
    .finally(() => {
        this.innerHTML = '<i class="fas fa-download me-1"></i>Export';
        this.disabled = false;
    });
});

// View on map
document.getElementById('viewMap').addEventListener('click', function() {
    if (currentResults.length === 0) {
        alert('No data to display on map. Please perform a search first.');
        return;
    }
    
    // Store results in sessionStorage and redirect to map
    sessionStorage.setItem('mapData', JSON.stringify(currentResults));
    window.location.href = '{{ url_for("map_page") }}';
});

// Show analytics
document.getElementById('showAnalytics').addEventListener('click', function() {
    if (currentResults.length === 0) {
        alert('No data for analytics. Please perform a search first.');
        return;
    }
    
    // Store results in sessionStorage and redirect to analytics
    sessionStorage.setItem('analyticsData', JSON.stringify(currentResults));
    window.location.href = '{{ url_for("analytics_page") }}';
});

function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const container = document.querySelector('.container');
    container.insertBefore(alertDiv, container.firstChild);
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}
</script>
{% endblock %}