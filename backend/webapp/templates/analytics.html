{% extends "base.html" %}

{% block title %}Analytics - EPC Data Explorer{% endblock %}

{% block content %}
<div class="row">
    <!-- Page Header -->
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="display-5 fw-bold text-primary">
                    <i class="fas fa-chart-bar me-3"></i>EPC Analytics
                </h1>
                <p class="lead text-muted">Analyze energy performance trends and insights</p>
            </div>
            <div class="btn-group">
                <button class="btn btn-success" id="loadFromSearch" style="display: none;">
                    <i class="fas fa-search me-1"></i>Load Search Results
                </button>
                <button class="btn btn-primary" id="newAnalysis">
                    <i class="fas fa-plus me-1"></i>New Analysis
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Data Summary Cards -->
<div class="row mb-4" id="summaryCards" style="display: none;">
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="stat-card">
            <div class="stat-number" id="totalRecords">0</div>
            <div class="stat-label">
                <i class="fas fa-home me-1"></i>Total Properties
            </div>
        </div>
    </div>
    
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="stat-card">
            <div class="stat-number" id="avgEfficiency">0</div>
            <div class="stat-label">
                <i class="fas fa-bolt me-1"></i>Avg Efficiency
            </div>
        </div>
    </div>
    
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="stat-card">
            <div class="stat-number" id="mostCommonRating">-</div>
            <div class="stat-label">
                <i class="fas fa-star me-1"></i>Common Rating
            </div>
        </div>
    </div>
    
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="stat-card">
            <div class="stat-number" id="improvementPotential">0%</div>
            <div class="stat-label">
                <i class="fas fa-arrow-up me-1"></i>Can Improve
            </div>
        </div>
    </div>
</div>

<!-- Charts Row 1 -->
<div class="row mb-4" id="chartsSection" style="display: none;">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Energy Rating Distribution</h5>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-light btn-sm" id="chartTypeBar" data-chart="energy_ratings" data-type="bar">Bar</button>
                    <button class="btn btn-outline-light btn-sm" id="chartTypePie" data-chart="energy_ratings" data-type="pie">Pie</button>
                </div>
            </div>
            <div class="card-body">
                <div id="energyRatingsChart" style="height: 400px;"></div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Property Types</h5>
            </div>
            <div class="card-body">
                <div id="propertyTypesChart" style="height: 400px;"></div>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row 2 -->
<div class="row mb-4" id="chartsSection2" style="display: none;">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-chart-area me-2"></i>Efficiency Score Distribution</h5>
            </div>
            <div class="card-body">
                <div id="efficiencyHistogramChart" style="height: 350px;"></div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-warning text-white">
                <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Current vs Potential Efficiency</h5>
            </div>
            <div class="card-body">
                <div id="efficiencyComparisonChart" style="height: 350px;"></div>
            </div>
        </div>
    </div>
</div>

<!-- Additional Analytics -->
<div class="row mb-4" id="additionalAnalytics" style="display: none;">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0"><i class="fas fa-table me-2"></i>Energy Performance Summary</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm" id="summaryTable">
                        <thead>
                            <tr>
                                <th>Energy Rating</th>
                                <th>Count</th>
                                <th>Percentage</th>
                                <th>Avg Efficiency</th>
                                <th>Avg Floor Area (mÂ²)</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0"><i class="fas fa-lightbulb me-2"></i>Key Insights</h5>
            </div>
            <div class="card-body">
                <div id="keyInsights">
                    <div class="text-center text-muted">
                        <small>Load data to see insights</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- No Data State -->
<div class="row" id="noDataState">
    <div class="col-12">
        <div class="card">
            <div class="card-body py-5">
                <div class="text-center text-muted">
                    <i class="fas fa-chart-bar fa-5x mb-4"></i>
                    <h3>No Data Loaded</h3>
                    <p class="lead">Load search results or perform a new search to view analytics</p>
                    <div class="mt-4">
                        <a href="{{ url_for('search_page') }}" class="btn btn-primary btn-lg me-3">
                            <i class="fas fa-search me-2"></i>Search EPC Data
                        </a>
                        <button class="btn btn-outline-primary btn-lg" id="loadSampleData">
                            <i class="fas fa-flask me-2"></i>Load Sample Data
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
let currentAnalyticsData = [];
let currentCharts = {};

document.addEventListener('DOMContentLoaded', function() {
    // Check if we have data from search results
    const searchData = sessionStorage.getItem('analyticsData');
    if (searchData) {
        document.getElementById('loadFromSearch').style.display = 'inline-block';
        document.getElementById('loadFromSearch').addEventListener('click', function() {
            const data = JSON.parse(searchData);
            loadAnalyticsData(data);
            sessionStorage.removeItem('analyticsData'); // Clear after use
            this.style.display = 'none';
        });
    }
    
    initializeEventListeners();
});

function initializeEventListeners() {
    // New analysis button
    document.getElementById('newAnalysis').addEventListener('click', function() {
        window.location.href = '{{ url_for("search_page") }}';
    });
    
    // Chart type toggles
    document.querySelectorAll('[data-chart][data-type]').forEach(button => {
        button.addEventListener('click', function() {
            const chartId = this.dataset.chart;
            const chartType = this.dataset.type;
            
            // Update button states
            const siblingButtons = document.querySelectorAll(`[data-chart="${chartId}"]`);
            siblingButtons.forEach(btn => {
                btn.classList.remove('btn-light');
                btn.classList.add('btn-outline-light');
            });
            this.classList.remove('btn-outline-light');
            this.classList.add('btn-light');
            
            // Redraw chart
            if (currentCharts[chartId]) {
                redrawChart(chartId, chartType);
            }
        });
    });
    
    // Load sample data
    document.getElementById('loadSampleData').addEventListener('click', loadSampleData);
}

function loadAnalyticsData(data) {
    if (!data || data.length === 0) {
        return;
    }
    
    currentAnalyticsData = data;
    
    // Hide no data state
    document.getElementById('noDataState').style.display = 'none';
    
    // Show analytics sections
    document.getElementById('summaryCards').style.display = 'block';
    document.getElementById('chartsSection').style.display = 'block';
    document.getElementById('chartsSection2').style.display = 'block';
    document.getElementById('additionalAnalytics').style.display = 'block';
    
    // Generate analytics
    generateAnalytics(data);
}

function generateAnalytics(data) {
    // Show loading state
    showLoadingState();
    
    fetch('/api/analytics', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ data: data })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            updateSummaryCards(result.data_summary);
            renderCharts(result.charts);
            updateSummaryTable(data);
            generateKeyInsights(data, result.data_summary);
        } else {
            alert('Analytics generation failed: ' + (result.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Analytics error:', error);
        alert('Analytics failed: ' + error.message);
    });
}

function showLoadingState() {
    const chartContainers = [
        'energyRatingsChart',
        'propertyTypesChart', 
        'efficiencyHistogramChart',
        'efficiencyComparisonChart'
    ];
    
    chartContainers.forEach(id => {
        document.getElementById(id).innerHTML = `
            <div class="d-flex align-items-center justify-content-center h-100">
                <div class="text-center">
                    <div class="loading-spinner" style="width: 30px; height: 30px; border-width: 3px;"></div>
                    <div class="mt-2"><small>Generating chart...</small></div>
                </div>
            </div>
        `;
    });
}

function updateSummaryCards(summary) {
    document.getElementById('totalRecords').textContent = summary.total_records.toLocaleString();
    document.getElementById('avgEfficiency').textContent = summary.avg_efficiency ? summary.avg_efficiency.toFixed(1) : 'N/A';
    document.getElementById('mostCommonRating').innerHTML = `<span class="energy-rating ${summary.most_common_rating}">${summary.most_common_rating}</span>`;
    
    // Calculate improvement potential
    const potentialImprovement = calculateImprovementPotential(currentAnalyticsData);
    document.getElementById('improvementPotential').textContent = potentialImprovement + '%';
}

function renderCharts(charts) {
    // Energy ratings chart
    if (charts.energy_ratings) {
        currentCharts.energy_ratings = charts.energy_ratings;
        Plotly.newPlot('energyRatingsChart', charts.energy_ratings.data, charts.energy_ratings.layout, {responsive: true});
    }
    
    // Property types chart
    if (charts.property_types) {
        currentCharts.property_types = charts.property_types;
        Plotly.newPlot('propertyTypesChart', charts.property_types.data, charts.property_types.layout, {responsive: true});
    }
    
    // Efficiency histogram
    if (charts.efficiency_histogram) {
        currentCharts.efficiency_histogram = charts.efficiency_histogram;
        Plotly.newPlot('efficiencyHistogramChart', charts.efficiency_histogram.data, charts.efficiency_histogram.layout, {responsive: true});
    }
    
    // Generate efficiency comparison chart
    generateEfficiencyComparisonChart();
}

function generateEfficiencyComparisonChart() {
    const data = currentAnalyticsData;
    const currentEfficiencies = [];
    const potentialEfficiencies = [];
    
    data.forEach(property => {
        const current = parseFloat(property['current-energy-efficiency']);
        const potential = parseFloat(property['potential-energy-efficiency']);
        
        if (!isNaN(current) && !isNaN(potential)) {
            currentEfficiencies.push(current);
            potentialEfficiencies.push(potential);
        }
    });
    
    const comparisonData = [{
        x: currentEfficiencies,
        y: potentialEfficiencies,
        mode: 'markers',
        type: 'scatter',
        name: 'Properties',
        marker: {
            color: currentEfficiencies.map(val => val < 50 ? '#e74c3c' : val < 70 ? '#f39c12' : '#27ae60'),
            size: 6,
            opacity: 0.7
        }
    }, {
        x: [0, 100],
        y: [0, 100],
        mode: 'lines',
        type: 'scatter',
        name: 'No Improvement Line',
        line: {
            color: '#95a5a6',
            dash: 'dash'
        }
    }];
    
    const comparisonLayout = {
        title: '',
        xaxis: { title: 'Current Efficiency Score' },
        yaxis: { title: 'Potential Efficiency Score' },
        hovermode: 'closest',
        margin: { l: 50, r: 30, t: 30, b: 50 }
    };
    
    Plotly.newPlot('efficiencyComparisonChart', comparisonData, comparisonLayout, {responsive: true});
}

function updateSummaryTable(data) {
    const ratingSummary = {};
    
    data.forEach(property => {
        const rating = property['current-energy-rating'] || 'Unknown';
        const efficiency = parseFloat(property['current-energy-efficiency']);
        const floorArea = parseFloat(property['total-floor-area']);
        
        if (!ratingSummary[rating]) {
            ratingSummary[rating] = {
                count: 0,
                efficiencies: [],
                floorAreas: []
            };
        }
        
        ratingSummary[rating].count++;
        if (!isNaN(efficiency)) ratingSummary[rating].efficiencies.push(efficiency);
        if (!isNaN(floorArea)) ratingSummary[rating].floorAreas.push(floorArea);
    });
    
    const tbody = document.querySelector('#summaryTable tbody');
    tbody.innerHTML = '';
    
    const ratingOrder = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'Unknown'];
    
    ratingOrder.forEach(rating => {
        if (ratingSummary[rating]) {
            const summary = ratingSummary[rating];
            const percentage = ((summary.count / data.length) * 100).toFixed(1);
            const avgEfficiency = summary.efficiencies.length > 0 
                ? (summary.efficiencies.reduce((a, b) => a + b, 0) / summary.efficiencies.length).toFixed(1)
                : 'N/A';
            const avgFloorArea = summary.floorAreas.length > 0
                ? Math.round(summary.floorAreas.reduce((a, b) => a + b, 0) / summary.floorAreas.length)
                : 'N/A';
            
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><span class="energy-rating ${rating}">${rating}</span></td>
                <td>${summary.count.toLocaleString()}</td>
                <td>${percentage}%</td>
                <td>${avgEfficiency}</td>
                <td>${avgFloorArea}</td>
            `;
            tbody.appendChild(row);
        }
    });
}

function generateKeyInsights(data, summary) {
    const insights = [];
    
    // Most common rating insight
    insights.push(`<div class="mb-3"><i class="fas fa-star text-warning me-2"></i><strong>Most common energy rating is ${summary.most_common_rating}</strong></div>`);
    
    // Efficiency insight
    if (summary.avg_efficiency) {
        const efficiencyLevel = summary.avg_efficiency > 70 ? 'good' : summary.avg_efficiency > 50 ? 'moderate' : 'poor';
        insights.push(`<div class="mb-3"><i class="fas fa-bolt text-primary me-2"></i>Average efficiency score of <strong>${summary.avg_efficiency.toFixed(1)}</strong> indicates ${efficiencyLevel} performance</div>`);
    }
    
    // Improvement potential
    const improvementPotential = calculateImprovementPotential(data);
    if (improvementPotential > 0) {
        insights.push(`<div class="mb-3"><i class="fas fa-arrow-up text-success me-2"></i><strong>${improvementPotential}%</strong> of properties could improve their rating</div>`);
    }
    
    // Property type insight
    const propertyTypes = {};
    data.forEach(p => {
        const type = p['property-type'];
        if (type) propertyTypes[type] = (propertyTypes[type] || 0) + 1;
    });
    const dominantType = Object.keys(propertyTypes).reduce((a, b) => propertyTypes[a] > propertyTypes[b] ? a : b);
    insights.push(`<div class="mb-3"><i class="fas fa-home text-info me-2"></i>Most common property type: <strong>${dominantType}</strong></div>`);
    
    document.getElementById('keyInsights').innerHTML = insights.join('');
}

function calculateImprovementPotential(data) {
    let canImprove = 0;
    
    data.forEach(property => {
        const current = property['current-energy-rating'];
        const potential = property['potential-energy-rating'];
        
        if (current && potential && current !== potential) {
            const currentValue = getRatingValue(current);
            const potentialValue = getRatingValue(potential);
            
            if (potentialValue > currentValue) {
                canImprove++;
            }
        }
    });
    
    return data.length > 0 ? Math.round((canImprove / data.length) * 100) : 0;
}

function getRatingValue(rating) {
    const values = { 'G': 1, 'F': 2, 'E': 3, 'D': 4, 'C': 5, 'B': 6, 'A': 7 };
    return values[rating] || 0;
}

function redrawChart(chartId, chartType) {
    const chartData = currentCharts[chartId];
    if (!chartData) return;
    
    let newData = [...chartData.data];
    let newLayout = {...chartData.layout};
    
    if (chartType === 'pie' && newData[0].type === 'bar') {
        // Convert bar to pie
        newData[0] = {
            labels: newData[0].x,
            values: newData[0].y,
            type: 'pie',
            marker: newData[0].marker
        };
        newLayout.xaxis = undefined;
        newLayout.yaxis = undefined;
    } else if (chartType === 'bar' && newData[0].type === 'pie') {
        // Convert pie to bar
        newData[0] = {
            x: newData[0].labels,
            y: newData[0].values,
            type: 'bar',
            marker: newData[0].marker
        };
        newLayout.xaxis = chartData.layout.xaxis || { title: 'Energy Rating' };
        newLayout.yaxis = chartData.layout.yaxis || { title: 'Number of Properties' };
    }
    
    const containerId = chartId === 'energy_ratings' ? 'energyRatingsChart' : chartId + 'Chart';
    Plotly.newPlot(containerId, newData, newLayout, {responsive: true});
}

function loadSampleData() {
    // Generate sample data for demonstration
    const sampleData = generateSampleData();
    loadAnalyticsData(sampleData);
}

function generateSampleData() {
    const ratings = ['A', 'B', 'C', 'D', 'E', 'F', 'G'];
    const propertyTypes = ['Flat', 'House', 'Bungalow', 'Maisonette'];
    const sampleData = [];
    
    for (let i = 0; i < 100; i++) {
        const rating = ratings[Math.floor(Math.random() * ratings.length)];
        const efficiency = Math.floor(Math.random() * 50) + 30 + (ratings.indexOf(rating) * 10);
        const potentialEfficiency = Math.min(100, efficiency + Math.floor(Math.random() * 20) + 5);
        
        sampleData.push({
            'current-energy-rating': rating,
            'potential-energy-rating': ratings[Math.min(ratings.indexOf(rating) + Math.floor(Math.random() * 3) + 1, 6)],
            'current-energy-efficiency': efficiency,
            'potential-energy-efficiency': potentialEfficiency,
            'property-type': propertyTypes[Math.floor(Math.random() * propertyTypes.length)],
            'total-floor-area': Math.floor(Math.random() * 200) + 50,
            'address1': `Sample Property ${i + 1}`,
            'postcode': `GU${Math.floor(Math.random() * 9) + 1} ${Math.floor(Math.random() * 9) + 1}AA`,
            'local-authority': 'Sample Authority'
        });
    }
    
    return sampleData;
}
</script>
{% endblock %}